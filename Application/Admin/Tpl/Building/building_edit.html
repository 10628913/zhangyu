<link rel="stylesheet" type="text/css" href="{:C('ADMIN_PLUGIN_PATH')}/webuploader/webuploader.css" />
<link rel="stylesheet" type="text/css" href="{:C('ADMIN_PLUGIN_PATH')}/webuploader/style.css" />
<div class="padding-md">
	<div class="smart-widget widget-dark-blue">
		<div class="paddingTLR-md">
			<a href="__CONTROLLER__/index" class="btn btn-xs">房源管理</a>
			<a href="__CONTROLLER__/buildingAdd" class="btn btn-xs">新增房源</a>
			<a href="#" class="btn btn-xs btn-info">房源编辑</a>
		</div>
		<div class="smart-widget-inner">
			<div class="smart-widget-body">
				<form class="form-horizontal no-margin form-border" method="post" id="form">
					<input type="hidden" name="building_id" value="{$building_id}">
					<div class="form-group">
						<label class="control-label col-md-2">房源名称</label>
						<div class="col-md-10">
							<input type="text" class="form-control" name="info[building_name]" value="{$building_name}" required>
						</div>
					</div>
					<div class="form-group">
						<label class="control-label col-md-2">关键词</label>
						<div class="col-md-10">
							<textarea name="info[building_keywords]" class="form-control" rows="2">{$building_keywords}</textarea>
						</div>
					</div>
					<div class="form-group">
						<label class="control-label col-md-2">描述</label>
						<div class="col-md-10">
							<textarea name="info[building_description]" class="form-control" rows="5">{$building_description}</textarea>
						</div>
					</div>
					<div class="form-group">
						<label class="control-label col-md-2">折扣信息</label>
						<div class="col-md-10">
							<input type="text" class="form-control" name="info[building_discount]" value="{$building_discount}">
						</div>
					</div>
					<div class="form-group">
						<label class="control-label col-md-2">咨询电话</label>
						<div class="col-md-10">
							<input type="text" class="form-control" name="info[building_consult_phone]" value="{$building_consult_phone}">
						</div>
					</div>

					<div class="form-group">
						<label class="control-label col-md-2">房源标签</label>
						<div class="col-md-10 m-top-xs">
							<label>
								<foreach name="buildingTagsList" item="v">
									<label><input type="checkbox" name="info[building_tags_ids][]" value="{$v['tags_id']}" <php> if(in_array($v['tags_id'],$building_tags_ids)){echo "checked";}</php>> {$v['tags_name']}&nbsp;</label>
								</foreach>
							</label>
						</div>
					</div>
					<div class="form-group">
						<label class="control-label col-md-2">建筑类型</label>
						<div class="col-md-10 m-top-xs">
							<label>
								<foreach name="buildingTypeList" item="v">
									<label><input type="radio" name="info[building_type_id]" value="{$v['type_id']}" <if condition="$building_type_id eq $v['type_id']">checked</if>> {$v['type_name']}&nbsp;</label>
								</foreach>
							</label>
						</div>
					</div>
					<div class="form-group">
						<label class="control-label col-md-2">房源户型</label>
						<div class="col-md-10 m-top-xs">
							<label>
								<foreach name="buildingHouseStyleList" item="v">
									<label><input type="checkbox" name="info[building_house_style_ids][]" value="{$v['house_style_id']}" <php> if(in_array($v['house_style_id'],$building_house_style_ids)){echo "checked";}</php>> {$v['house_style_name']}&nbsp;</label>
								</foreach>
							</label>
						</div>
					</div>
					<div class="form-group">
						<label class="control-label col-md-2">楼盘均价</label>
						<div class="col-md-4">
							<div class="input-group">
								<input type="text" class="form-control" name="info[building_price_sqm]" value="{$building_price_sqm}">
								<span class="input-group-addon">元/㎡</span>
							</div>
						</div>
						<label class="control-label col-md-2">开盘时间</label>
						<div class="col-md-4">
							<input type="date" class="form-control" name="info[building_open_date]" value="{$building_open_date}">
						</div>
					</div>
					<div class="form-group">
						<label class="control-label col-md-2">开发商</label>
						<div class="col-md-8">
							<input type="text" class="form-control" name="info[building_developer]" value="{$building_developer}">
						</div>
					</div>
					<div class="form-group">
						<label class="control-label col-md-2">产权年限</label>
						<div class="col-md-4">
							<div class="input-group">
								<input type="text" class="form-control" name="info[building_age]" value="{$building_age}">
								<span class="input-group-addon">年</span>
							</div>
						</div>
						<label class="control-label col-md-2">装修标准</label>
						<div class="col-md-4">
							<input type="text" class="form-control" name="info[building_renovate]" value="{$building_renovate}">
						</div>
					</div>
					<div class="form-group">
						<label class="control-label col-md-2">物业公司</label>
						<div class="col-md-4">
							<input type="text" class="form-control" name="info[building_property]" value="{$building_property}">
						</div>
						<label class="control-label col-md-2">售楼地址</label>
						<div class="col-md-4">
							<input type="text" class="form-control" name="info[building_sale_address]" value="{$building_sale_address}">
						</div>
					</div>
					<div class="form-group">
						<label class="control-label col-md-2">车位数</label>
						<div class="col-md-4">
							<input type="text" class="form-control" name="info[building_park_count]" value="{$building_park_count}">
						</div>
						<label class="control-label col-md-2">车位配比</label>
						<div class="col-md-4">
							<input type="text" class="form-control" name="info[building_park]" value="{$building_park}">
						</div>
					</div>
					<div class="form-group">
						<label class="control-label col-md-2">楼盘户数</label>
						<div class="col-md-2">
							<input type="text" class="form-control" name="info[building_family_count]" value="{$building_family_count}">
						</div>
						<label class="control-label col-md-2">容积率</label>
						<div class="col-md-2">
							<input type="text" class="form-control" name="info[building_volume]" value="{$building_volume}">
						</div>
						<label class="control-label col-md-2">绿化率</label>
						<div class="col-md-2">
							<input type="text" class="form-control" name="info[building_green]" value="{$building_family_count}">
						</div>
					</div>
					<!-- <div class="form-group">
						<label class="control-label col-md-2">绿色率</label>
						<div class="col-md-4">
							<input type="text" class="form-control" name="info[building_family_count]" value="{$building_family_count}">
						</div>
					</div> -->

					<div class="form-group">
						<label class="control-label col-md-2">封面图片</label>
						<div class="col-md-5">
							<button type="button" class="btn btn-success btn-sm" id="selector">选取图片</button>
							<button type="button" class="btn btn-warning btn-sm hide" id="upload">上传</button>
							<span id="filepath"></span>
							<input type="hidden" name="info[building_thumb]" value="{$building_thumb}" />
							<p class="m-top-sm">
								<if condition="$building_thumb">
								<img src="{$building_thumb}" width="20%" id="building_thumb"/>
								<else />
								<img src="{:C('ADMIN_IMAGE_PATH')}/noimg.png" width="20%" id="building_thumb"/>
								</if>
							</p>
						</div>
					</div>
					<div class="form-group">
						<label class="control-label col-md-2">全景图片</label>
						<div class="col-md-5">
							<button type="button" class="btn btn-success btn-sm" id="building_panoramic_selector">选取图片</button>
							<button type="button" class="btn btn-warning btn-sm hide" id="building_panoramic_upload">上传</button>
							<span id="building_panoramic_filepath"></span>
							<input type="hidden" name="info[building_panoramic]" value="{$building_panoramic}" />
							<p class="m-top-sm">
								<if condition="$building_thumb">
								<img src="{$building_panoramic}" width="20%" id="building_thumb"/>
								<else />
								<img src="{:C('ADMIN_IMAGE_PATH')}/noimg.png" width="20%" id="building_panoramic"/>
								</if>

							</p>
						</div>
					</div>

					<div class="form-group">
						<label class="control-label col-md-2">楼盘地址</label>
						<div class="col-md-10 area selects">
							<input type="hidden" name="info[building_area_id]" value="{$building_area_id}">
							<input type="hidden" name="info[building_area_name]" value="{$building_area_name}">
							<span>{$building_area_name}</span>
							<a href="javascript:;" class="btn btn-xs btn-info area-edit">编辑</a>
							<select class="form-control" style="display:none">
				              	<option value="0">-请选择-</option>
				               	<foreach name="areaList" item="v">
								<option value="{$v['id']}">{$v['name']}</option>
				               	</foreach>
				            </select>
						</div>
					</div>
					<div class="form-group">
						<label class="control-label col-md-2">详细地址</label>
						<div class="col-md-10">
							<div class="input-group">
								<input type="text" class="form-control" name="info[building_address]" value="{$building_address}">
								<span class="input-group-btn">
									<button class="btn btn-info" type="button" onclick="geocoder()">定位搜索</button>
								</span>
							</div>
						</div>
					</div>

					<div class="form-group">
						<label class="control-label col-md-2">目的地地图标注</label>
						<div class="col-md-7">
							<div id="map" style="width:100%; height:320px;"></div>
                        	<div id="result"></div>
                        	<input type="hidden" name="info[building_lat]" value="{$building_lat}" id="lat" >
                        	<input type="hidden" name="info[building_lon]" value="{$building_lon}" id="lon">
                    	</div>
					</div>

					<div class="form-group">
						<label class="control-label col-md-2">详情</label>
						<div class="col-md-10">
							<textarea id="content" name="info[building_content]">{$building_content}</textarea>
							<php>echo $editor->editor('content',300);</php>
						</div>
					</div>
					<div class="form-group">
						<label class="control-label col-md-2">房源图片</label>
						<div class="col-md-10">
							<div id="uploader">
							    <!--用来存放item-->
							    <div id="fileList" class="uploader-list">
							    	<if condition="$building_photos">
										<foreach name="building_photos" item="v">
											<div id="old_file_{$key}" class="file-item building_thumbnail">
												<img src="{$v}" width="200">
												<div class="file-panel"><span class="cancel" data-id="old_file_{$key}">删除</span></div>
												<input type="hidden" value="{$v}" name="info[building_photos][]">
											</div>
										</foreach>
							    	</if>
							    </div>
							    <div id="filePicker" class="btn btn-info">选择图片</div>
							    <div id="ctlBtn" class="btn btn-default">开始上传</div>
							</div>
						</div>
					</div>
					<div class="form-group">
						<label class="control-label col-md-2">是否推荐</label>
						<div class="col-md-5 m-top-xs">
							<label>
								<input type="radio" name="info[recommend]" value="1" <if condition="$recommend eq 1">checked</if>>
								是
							</label>
							<label>
								<input type="radio" name="info[recommend]" value="0" <if condition="$recommend eq 0">checked</if>>
								否
							</label>
						</div>
					</div>
					<div class="form-group">
						<label class="control-label col-md-2">状态</label>
						<div class="col-md-5 m-top-xs">
							<label>
								<input type="radio" name="info[status]" value="1" <if condition="$status eq 1">checked</if>>
								待发布
							</label>
							<label>
								<input type="radio" name="info[status]" value="99" <if condition="$status eq 99">checked</if>>
								发布
							</label>
						</div>
					</div>

					<div class="text-center m-top-md">
						<button type="submit" class="btn btn-info">提交保存</button>
					</div>
				</form>
			</div>
		</div>
	</div>
</div>
<script src="{:C('ADMIN_JS_PATH')}/jquery.validate.min.js" type="text/javascript"></script>
<script src="{:C('ADMIN_JS_PATH')}/ajaxupload.js" type="text/javascript"></script>
<script type="text/javascript" src="{:C('ADMIN_PLUGIN_PATH')}/webuploader/webuploader.js"></script>
<script type="text/javascript" src="http://webapi.amap.com/maps?v=1.3&key=1734427266f6db50e5b15c1cf8cb9304&plugin=AMap.Geocoder"></script>
<script type="text/javascript" src="http://cache.amap.com/lbs/static/addToolbar.js"></script>
<script type="text/javascript">
	var map,marker,lnglatXY;
	$(function(){
        $("#form").validate({
	        submitHandler:function(form){
	            save();
	        }
	    });
	    // 创建一个上传参数
        var uploadOption = {
            // 提交目标
            action: "/index.php?m=Attachment&c=Index&a=adminUploadOne",
			// 服务端接收的名称
			name: "file",
            // 自动提交
            autoSubmit: true,
            // 选择文件之后…
            onChange: function (file, extension) {
                if (new RegExp(/(jpg)|(jpeg)|(gif)|(png)/i).test(extension)) {
                	$("#upload").removeClass("hide");
                    $("#filepath").text(file);
                } else {
                    DMS.alert("只限上传图片文件，请重新选择！");
                }
            },
            // 开始上传文件
            onSubmit: function (file, extension) {
                $("#upload").text("正在上传");
            },
            // 上传完成之后
            onComplete: function (file, response) {
            	var response = JSON.parse(jQuery(response).text());
            	if(response.status == 'success'){
            		$("#upload").text("上传完成");
            		$("[name='info[building_thumb]']").val(response.path);
            		$("#building_thumb").attr("src",response.path);
            	}
            }
        }

        // 初始化图片上传框
        var oAjaxUpload = new AjaxUpload('#selector', uploadOption);
        // 给上传按钮增加上传动作
        $("#upload").click(function (){
            oAjaxUpload.submit();
        });

        // 创建一个上传参数
        var uploadOption2 = {
            // 提交目标
            action: "/index.php?m=Attachment&c=Index&a=adminUploadOne",
			// 服务端接收的名称
			name: "file",
            // 自动提交
            autoSubmit: true,
            // 选择文件之后…
            onChange: function (file, extension) {
                if (new RegExp(/(jpg)|(jpeg)|(gif)|(png)/i).test(extension)) {
                	$("#building_panoramic_upload").removeClass("hide");
                    $("#building_panoramic_filepath").text(file);
                } else {
                    DMS.alert("只限上传图片文件，请重新选择！");
                }
            },
            // 开始上传文件
            onSubmit: function (file, extension) {
                $("#building_panoramic_upload").text("正在上传");
            },
            // 上传完成之后
            onComplete: function (file, response) {
            	var response = JSON.parse(jQuery(response).text());
            	if(response.status == 'success'){
            		$("#building_panoramic_upload").text("上传完成");
            		$("[name='info[building_panoramic]']").val(response.path);
            		$("#building_panoramic").attr("src",response.path);
            	}
            }
        }

        // 初始化图片上传框
        var oAjaxUpload2 = new AjaxUpload('#building_panoramic_selector', uploadOption2);
        // 给上传按钮增加上传动作
        $("#building_panoramic_upload").click(function (){
            oAjaxUpload2.submit();
        });
        $(".area > select").get(0).onchange = getAreaChange;
        $(".area-edit").click(areaEdit);
        // 地图
        var lat = "{$lat}";
		if(lat > 0){
			lnglatXY = [ '{$lon}',  '{$lat}'];
		}else{
			lnglatXY = '';
		}
		map = new AMap.Map('map',{
		    zoom: 17,
		    resizeEnable: true,
		    center: lnglatXY
		});
		if(lat > 0){
	        marker = new AMap.Marker({
	            map: map,
	            position: lnglatXY
	        });
    	}
		map.on('click', function(e) {
			if (marker) {
	            marker.setMap(null);
	            marker = null;
	        }
		    var lnglatXY = [ e.lnglat.getLng(),  e.lnglat.getLat()];
		    $("#lon").val(e.lnglat.getLng());
		    $("#lat").val(e.lnglat.getLat());
		    marker = new AMap.Marker({
		        map: map,
		        position: lnglatXY
		    });
		    var geocoder = new AMap.Geocoder({
		        radius: 1000,
		        extensions: "all"
		    });
		    geocoder.getAddress(lnglatXY, function(status, result) {
		        if (status === 'complete' && result.info === 'OK') {
		            var geocode = result.regeocode;
		            var infoWindow = new AMap.InfoWindow({
		                content: geocode.formattedAddress,
		                offset: {x: 0, y: -30}
		            });
		            var html = "<p style=\"font-size: 12px;padding:0px 0 4px 2px; border-bottom:1px solid #C1FFC1;\">" + "<b>地址</b>：" + geocode.formattedAddress + "" + "&nbsp;&nbsp;<b>的地理编码结果是:</b><b>&nbsp;&nbsp;&nbsp;&nbsp;坐标</b>：" + e.lnglat.getLng() + ", " + e.lnglat.getLat() + "" + "</p>";
		            document.getElementById("result").innerHTML = html;
		            infoWindow.open(map, marker.getPosition());
		            marker.on("click", function(e) {
		                infoWindow.open(map, marker.getPosition());
		                $("#lon").val(marker.getPosition().lng);
		                $("#lat").val(marker.getPosition().lat);
		            });
		        }
		    });
		});
		// 已传图片删除
		var imageBtns = $("#fileList .file-panel > span.cancel");
		if(imageBtns.length){
			imageBtns.on( 'click', function(e) {
                $("#"+this.getAttribute("data-id")).remove();
                return;
            });
		}
		var uploader,
			$btn = $('#ctlBtn'),
			$list = $('#fileList'),
	        ratio = window.devicePixelRatio || 1,
	        building_thumbnailWidth = 100 * ratio,
	        building_thumbnailHeight = 100 * ratio;
		// 多图上传
		uploader = WebUploader.create({
			// auto: true,
		    swf:"{:C('ADMIN_PLUGIN_PATH')}/Uploader.swf",
		    server: '/index.php?m=Attachment&c=Index&a=adminUploadOne',
		    pick: '#filePicker',
		    accept: {
		        title: 'Images',
		        extensions: 'gif,jpg,jpeg,bmp,png',
		        mimeTypes: 'image/*'
		    }
		});
		// 当有文件添加进来的时候
	    uploader.on( 'fileQueued', function( file ) {
	        var $li = $(
	                '<div id="' + file.id + '" class="file-item building_thumbnail">' +
	                    '<img>' +
	                    '<div class="info">' + file.name + '</div>' +
	                '</div>'
	                ),
	        	$btns = $('<div class="file-panel"><span class="cancel">删除</span></div>').appendTo( $li ),
	            $img = $li.find('img');
	        $list.append( $li );
	        $btns.on( 'click', 'span', function() {
                var index = $(this).index();
                switch ( index ) {
                    case 0:
                        var $li = $('#'+file.id);
			            $li.off().find('.file-panel').off().end().remove();
                        return;
                }
            });
	        // 创建缩略图
	        uploader.makeThumb( file, function( error, src ) {
	            if ( error ) {
	                $img.replaceWith('<span>不能预览</span>');
	                return;
	            }
	            $img.attr( 'src', src );
	        }, building_thumbnailWidth, building_thumbnailHeight );
	    });
	    // 文件上传过程中创建进度条实时显示。
	    uploader.on( 'uploadProgress', function( file, percentage ) {
	        var $li = $( '#'+file.id ),
	            $percent = $li.find('.progress span');

	        // 避免重复创建
	        if ( !$percent.length ) {
	            $percent = $('<p class="progress"><span></span></p>')
	                    .appendTo( $li )
	                    .find('span');
	        }
	        $percent.css( 'width', percentage * 100 + '%' );

	    });
	    // 文件上传成功，给item添加成功class, 用样式标记上传成功。
	    uploader.on( 'uploadSuccess', function( file,response ) {
	        $('#'+file.id).addClass('upload-state-done');
	        $('#'+file.id).append('<input type="hidden" value="'+response.path+'" name="info[building_photos][]">');
	    });
	    // 文件上传失败，现实上传出错。
	    uploader.on( 'uploadError', function( file ) {
	        var $li = $( '#'+file.id ),
	            $error = $li.find('div.error');
	        // 避免重复创建
	        if ( !$error.length ) {
	            $error = $('<div class="error"></div>').appendTo( $li );
	        }
	        $error.text('上传失败');
	    });
	    // 完成上传完了，成功或者失败，先删除进度条。
	    uploader.on( 'uploadComplete', function( file ) {
	        $( '#'+file.id ).find('.progress').remove();
	    });
	    //
	    $btn.on( 'click', function() {
	        uploader.upload();
	    });
    })
	function areaEdit(){
	    $(this).siblings("select").show();
	    $(this).siblings("span").andSelf().remove();
	}
    function getAreaChange(){
    	$(this).nextAll("select").remove();
    	var selects = $(this).siblings("select").andSelf();
    	var id = 0;
	    var names = new Array();
	    for (i = 0; i < selects.length; i++){
	        sel = selects[i];
	        if (sel.value > 0){
	            id = sel.value;
	            name = sel.options[sel.selectedIndex].text;
	            names.push(name);
	        }
	    }
	    $('input[name="info[building_area_id]"]').val(id);
	    $('input[name="info[building_area_name]"]').val(names.join(","));
	    if (this.value > 0){
	        var _self = this;
	        var url = '__MODULE__/Area/getAreaChildLists';
	        $.post(url, {'pid':this.value}, function(data){
	            if (data){
	                if (data.length > 0){
	                    $("<select class='form-control'><option>-请选择-</option></select>").change(getAreaChange).insertAfter(_self);
	                    var data  = data;
	                    for (i = 0; i < data.length; i++){
	                        $(_self).next("select").append("<option value='" + data[i].id + "'>" + data[i].name + "</option>");
	                    }
	                }
	            }
	        });
	    }
    }

    function geocoder(names) {
		var area = $('input[name="info[building_area_name]"]').val();
		if(area){
			area = area.replace(",","");
		}
		var building_address = $('input[name="info[building_address]"]').val();
	    var geocoder = new AMap.Geocoder({
	        radius: 1000
	    });
	    //地理编码,返回地理编码结果
	    geocoder.getLocation(area+building_address, function(status, result) {
	        if (status === 'complete' && result.info === 'OK') {
	            geocoder_CallBack(result);
	        }
	    });
	}
	function showAddress(geocode){
	    var html = "<p style=\"font-size: 12px;padding:0px 0 4px 2px; border-bottom:1px solid #C1FFC1;\">" + "<b>地址</b>：" + geocode.formattedAddress + "" + "&nbsp;&nbsp;<b>的地理编码结果是:</b><b>&nbsp;&nbsp;&nbsp;&nbsp;坐标</b>：" + geocode.location.getLng() + ", " + geocode.location.getLat() + "" + "<b>&nbsp;&nbsp;&nbsp;&nbsp;匹配级别</b>：" + geocode.level + "</p>";
	    document.getElementById("result").innerHTML = html;
	}
	function addMarker(i, d) {
		if (marker) {
            marker.setMap(null);
            marker = null;
        }
		$("#lon").val(d.location.getLng());
	    $("#lat").val(d.location.getLat());
	    marker = new AMap.Marker({
	        map: map,
	        position: [ d.location.getLng(),  d.location.getLat()]
	    });
	    var infoWindow = new AMap.InfoWindow({
	        content: d.formattedAddress,
	        offset: {x: 0, y: -30}
	    });
	    marker.on("click", function(e) {
	        infoWindow.open(map, marker.getPosition());
	        $("#lon").val(marker.getPosition().lng);
	        $("#lat").val(marker.getPosition().lat);
	    });
	}
	//地理编码返回结果展示
	function geocoder_CallBack(data) {
	    var resultStr = "";
	    //地理编码结果数组
	    var geocode = data.geocodes;
	    for (var i = 0; i < geocode.length; i++) {
	        //拼接输出html
	        showAddress(geocode[i]);
	        addMarker(i, geocode[i]);
	    }
	    map.setFitView();
	}
	//处理CKEDITOR的值
    function CKupdate(){
        for (instance in CKEDITOR.instances){
            CKEDITOR.instances[instance].updateElement();
        }
    }
	function save() {
		CKupdate();
		DMS.ajaxPost("__CONTROLLER__/buildingEdit",$('#form').serialize(),function(ret){
			if(ret.status==1){
            	DMS.success(ret.info,0,function(){
					if(ret.url){
            			window.location.href = ret.url;
            		}else{
            			window.location.href = window.location.href;
            		}
				});
            }else{
            	DMS.error(''+ret.info+'',0);
            }
		})
    }
</script>
