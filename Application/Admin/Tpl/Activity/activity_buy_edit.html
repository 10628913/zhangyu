<link rel="stylesheet" type="text/css" href="{:C('ADMIN_PLUGIN_PATH')}/webuploader/webuploader.css" />
<link rel="stylesheet" type="text/css" href="{:C('ADMIN_PLUGIN_PATH')}/webuploader/style.css" />
<div class="padding-md">
	<div class="smart-widget widget-dark-blue">
		<div class="paddingTLR-md">
			<a href="__CONTROLLER__/activityBuyList" class="btn btn-xs">团购活动管理</a>
			<a href="__CONTROLLER__/activityBuyAdd" class="btn btn-xs btn-info">发布团购活动</a>
			<a href="#" class="btn btn-xs btn-info">编辑团购活动</a>
		</div>
		<div class="smart-widget-inner">
			<div class="smart-widget-body">
				<form class="form-horizontal no-margin form-border" method="post" id="form">
					<input type="hidden" class="form-control" name="activity_id" value="{$activity_id}" required>
					<div class="form-group">
						<label class="control-label col-md-2">活动标题</label>
						<div class="col-md-10">
							<input type="text" class="form-control" name="info[activity_title]" value="{$activity_title}" required>
						</div>
					</div>
					<div class="form-group">
						<label class="control-label col-md-2">关键词</label>
						<div class="col-md-10">
							<textarea name="info[activity_keywords]" class="form-control" rows="2">{$activity_keywords}</textarea>
						</div>
					</div>
					<div class="form-group">
						<label class="control-label col-md-2">描述</label>
						<div class="col-md-10">
							<textarea name="info[activity_description]" class="form-control" rows="5">{$activity_description}</textarea>
						</div>
					</div>
					<div class="form-group">
						<label class="control-label col-md-2">优惠信息</label>
						<div class="col-md-10">
							<input type="text" class="form-control" name="info[activity_preferential]" value="{$activity_preferential}">
						</div>
					</div>

					<div class="form-group">
						<label class="control-label col-md-2">原价</label>
						<div class="col-md-4">
							<div class="input-group">
								<input type="text" class="form-control" name="info[activity_cost_price]" value="{$activity_cost_price}">
								<span class="input-group-addon">元</span>
							</div>
						</div>
						<label class="control-label col-md-2">活动优惠价格</label>
						<div class="col-md-4">
							<div class="input-group">
								<input type="text" class="form-control" name="info[activity_preferential_price]" value="{$activity_preferential_price}">
								<span class="input-group-addon">元</span>
							</div>
						</div>
					</div>
					<div class="form-group">
						<label class="control-label col-md-2">均价</label>
						<div class="col-md-4">
							<div class="input-group">
								<input type="text" class="form-control" name="info[activity_average_price]" value="{$activity_average_price}">
								<span class="input-group-addon">元</span>
							</div>
						</div>
						<label class="control-label col-md-2">订金</label>
						<div class="col-md-4">
							<div class="input-group">
								<input type="text" class="form-control" name="info[activity_deposit]" value="{$activity_deposit}">
								<span class="input-group-addon">元</span>
							</div>
						</div>
					</div>
					<div class="form-group">
						<label class="control-label col-md-2">活动开始时间</label>
						<div class="col-md-4">
							<input type="date" class="form-control" name="info[activity_start_date]" value="{$activity_start_date}" required="">
						</div>
						<label class="control-label col-md-2">活动结束时间</label>
						<div class="col-md-4">
							<input type="date" class="form-control" name="info[activity_end_date]" value="{$activity_end_date}" required="">
						</div>
					</div>
					<div class="form-group">
						<label class="control-label col-md-2">活动人数</label>
						<div class="col-md-4">
							<input type="text" class="form-control" name="info[activity_pepole_number]" value="{$activity_pepole_number}">
						</div>
						<label class="control-label col-md-2">咨询电话</label>
						<div class="col-md-4">
							<input type="text" class="form-control" name="info[activity_consult_phone]" value="{$activity_consult_phone}">
						</div>
					</div>
					<div class="form-group">
						<label class="control-label col-md-2">关联房源ID</label>
						<div class="col-md-3">
							<input type="text" class="form-control" name="info[activity_buy_building_id]" value="{$activity_buy_building_id}">
						</div>
						<label class="control-label col-md-2">房源名称</label>
						<div class="col-md-5">
							<input type="text" class="form-control" name="info[activity_buy_building_name]" value="{$activity_buy_building_name}">
						</div>
					</div>
					<div class="form-group">
						<label class="control-label col-md-2">封面图片</label>
						<div class="col-md-5">
							<button type="button" class="btn btn-success btn-sm" id="selector">选取图片</button>
							<button type="button" class="btn btn-warning btn-sm hide" id="upload">上传</button>
							<span id="filepath"></span>
							<input type="hidden" name="info[activity_thumb]" value="{$activity_thumb}" />
							<p class="m-top-sm">
								<if condition="activity_thumb">
								<img src="{$activity_thumb}" width="20%" id="activity_thumb"/>
								<else />
								<img src="{:C('ADMIN_IMAGE_PATH')}/noimg.png" width="20%" id="activity_thumb"/>
								</if>
							</p>
						</div>
					</div>

					<div class="form-group">
						<label class="control-label col-md-2">活动地区</label>
						<div class="col-md-10 area selects">
							<input type="hidden" name="info[activity_area_ids]" value="{$activity_area_ids}">
							<input type="hidden" name="info[activity_area_name]" value="{$activity_area_name}">
							<span>{$activity_area_name}</span>
							<a href="javascript:;" class="btn btn-xs btn-info area-edit">编辑</a>
							<select class="form-control" style="display:none">
				              	<option value="0">-请选择-</option>
				               	<foreach name="areaList" item="v">
								<option value="{$v['id']}">{$v['name']}</option>
				               	</foreach>
				            </select>
						</div>
					</div>
					<div class="form-group">
						<label class="control-label col-md-2">详细地址</label>
						<div class="col-md-10">
							<div class="input-group">
								<input type="text" class="form-control" name="info[activity_address]" value="{$activity_address}">
								<span class="input-group-btn">
									<button class="btn btn-info" type="button" onclick="geocoder()">定位搜索</button>
								</span>
							</div>
						</div>
					</div>
					<div class="form-group">
						<label class="control-label col-md-2">集合时间</label>
						<div class="col-md-3">
							<input type="text" class="form-control" name="info[activity_set_time]" value="{$activity_set_time}">
						</div>
						<label class="control-label col-md-2">集合地点</label>
						<div class="col-md-5">
							<input type="text" class="form-control" name="info[activity_set_address]" value="{$activity_set_address}">
						</div>
					</div>

					<div class="form-group">
						<label class="control-label col-md-2">目的地地图标注</label>
						<div class="col-md-7">
							<div id="map" style="width:100%; height:320px;"></div>
                        	<div id="result"></div>
                        	<input type="hidden" name="info[activity_lat]" id="lat" value="{$activity_lat}">
                        	<input type="hidden" name="info[activity_lon]" id="lon" value="{$activity_lon}">
                    	</div>
					</div>

					<div class="form-group">
						<label class="control-label col-md-2">活动详情</label>
						<div class="col-md-10">
							<textarea id="content" name="info[activity_content]">{$activity_content}</textarea>
							<php>echo $editor->editor('content',300);</php>
						</div>
					</div>
					<div class="form-group">
						<label class="control-label col-md-2">活动图片</label>
						<div class="col-md-10">
							<div id="uploader">
							    <!--用来存放item-->
							    <div id="fileList" class="uploader-list">
							    	<if condition="$activity_photos">
										<foreach name="activity_photos" item="v">
											<div id="old_file_{$key}" class="file-item activity_thumbnail">
												<img src="{$v}" width="200">
												<div class="file-panel"><span class="cancel" data-id="old_file_{$key}">删除</span></div>
												<input type="hidden" value="{$v}" name="info[activity_photos][]">
											</div>
										</foreach>
							    	</if>
							    </div>
							    <div id="filePicker" class="btn btn-info">选择图片</div>
							    <div id="ctlBtn" class="btn btn-default">开始上传</div>
							</div>
						</div>
					</div>
					<div class="form-group">
						<label class="control-label col-md-2">是否推荐</label>
						<div class="col-md-5 m-top-xs">
							<label>
								<input type="radio" name="info[activity_recommend]" value="1" <if condition="$activity_recommend eq 1">checked</if>>
								是
							</label>
							<label>
								<input type="radio" name="info[activity_recommend]" value="0" <if condition="$activity_recommend eq 0">checked</if>>
								否
							</label>
						</div>
					</div>
					<div class="form-group">
						<label class="control-label col-md-2">状态</label>
						<div class="col-md-5 m-top-xs">
							<label>
								<input type="radio" name="info[activity_status]" value="1" <if condition="$activity_status eq 1">checked</if>>
								待发布
							</label>
							<label>
								<input type="radio" name="info[activity_status]" value="99" <if condition="$activity_status eq 99">checked</if>>
								发布
							</label>
						</div>
					</div>

					<div class="text-center m-top-md">
						<button type="submit" class="btn btn-info">提交保存</button>
					</div>
				</form>
			</div>
		</div>
	</div>
</div>
<script src="{:C('ADMIN_JS_PATH')}/jquery.validate.min.js" type="text/javascript"></script>
<script src="{:C('ADMIN_JS_PATH')}/ajaxupload.js" type="text/javascript"></script>
<script type="text/javascript" src="{:C('ADMIN_PLUGIN_PATH')}/webuploader/webuploader.js"></script>
<script type="text/javascript" src="http://webapi.amap.com/maps?v=1.3&key=1734427266f6db50e5b15c1cf8cb9304&plugin=AMap.Geocoder"></script>
<script type="text/javascript" src="http://cache.amap.com/lbs/static/addToolbar.js"></script>
<script type="text/javascript">
	var map,marker,lnglatXY;
	$(function(){
        $("#form").validate({
	        submitHandler:function(form){
	            save();
	        }
	    });
	    // 创建一个上传参数
        var uploadOption = {
            // 提交目标
            action: "/index.php?m=Attachment&c=Index&a=adminUploadOne",
			// 服务端接收的名称
			name: "file",
            // 自动提交
            autoSubmit: true,
            // 选择文件之后…
            onChange: function (file, extension) {
                if (new RegExp(/(jpg)|(jpeg)|(gif)|(png)/i).test(extension)) {
                	$("#upload").removeClass("hide");
                    $("#filepath").text(file);
                } else {
                    DMS.alert("只限上传图片文件，请重新选择！");
                }
            },
            // 开始上传文件
            onSubmit: function (file, extension) {
                $("#upload").text("正在上传");
            },
            // 上传完成之后
            onComplete: function (file, response) {
            	var response = JSON.parse(jQuery(response).text());
            	if(response.status == 'success'){
            		$("#upload").text("上传完成");
            		$("[name='info[activity_thumb]']").val(response.path);
            		$("#activity_thumb").attr("src",response.path);
            	}
            }
        }

        // 初始化图片上传框
        var oAjaxUpload = new AjaxUpload('#selector', uploadOption);
        // 给上传按钮增加上传动作
        $("#upload").click(function (){
            oAjaxUpload.submit();
        });


        $(".area > select").get(0).onchange = getAreaChange;
        $(".area-edit").click(areaEdit);
        // 地图
        var lat = "{$activity_lat}";
		if(lat > 0){
			lnglatXY = [ '{$activity_lon}',  '{$activity_lat}'];
		}else{
			lnglatXY = '';
		}
		map = new AMap.Map('map',{
		    zoom: 17,
		    resizeEnable: true,
		    center: lnglatXY
		});
		if(lat > 0){
	        marker = new AMap.Marker({
	            map: map,
	            position: lnglatXY
	        });
    	}
		map.on('click', function(e) {
			if (marker) {
	            marker.setMap(null);
	            marker = null;
	        }
		    var lnglatXY = [ e.lnglat.getLng(),  e.lnglat.getLat()];
		    $("#lon").val(e.lnglat.getLng());
		    $("#lat").val(e.lnglat.getLat());
		    marker = new AMap.Marker({
		        map: map,
		        position: lnglatXY
		    });
		    var geocoder = new AMap.Geocoder({
		        radius: 1000,
		        extensions: "all"
		    });
		    geocoder.getAddress(lnglatXY, function(status, result) {
		        if (status === 'complete' && result.info === 'OK') {
		            var geocode = result.regeocode;
		            var infoWindow = new AMap.InfoWindow({
		                content: geocode.formattedAddress,
		                offset: {x: 0, y: -30}
		            });
		            var html = "<p style=\"font-size: 12px;padding:0px 0 4px 2px; border-bottom:1px solid #C1FFC1;\">" + "<b>地址</b>：" + geocode.formattedAddress + "" + "&nbsp;&nbsp;<b>的地理编码结果是:</b><b>&nbsp;&nbsp;&nbsp;&nbsp;坐标</b>：" + e.lnglat.getLng() + ", " + e.lnglat.getLat() + "" + "</p>";
		            document.getElementById("result").innerHTML = html;
		            infoWindow.open(map, marker.getPosition());
		            marker.on("click", function(e) {
		                infoWindow.open(map, marker.getPosition());
		                $("#lon").val(marker.getPosition().lng);
		                $("#lat").val(marker.getPosition().lat);
		            });
		        }
		    });
		});
		// 已传图片删除
		var imageBtns = $("#fileList .file-panel > span.cancel");
		if(imageBtns.length){
			imageBtns.on( 'click', function(e) {
                $("#"+this.getAttribute("data-id")).remove();
                return;
            });
		}
		var uploader,
			$btn = $('#ctlBtn'),
			$list = $('#fileList'),
	        ratio = window.devicePixelRatio || 1,
	        activity_thumbnailWidth = 100 * ratio,
	        activity_thumbnailHeight = 100 * ratio;
		// 多图上传
		uploader = WebUploader.create({
			// auto: true,
		    swf:"{:C('ADMIN_PLUGIN_PATH')}/Uploader.swf",
		    server: '/index.php?m=Attachment&c=Index&a=adminUploadOne',
		    pick: '#filePicker',
		    accept: {
		        title: 'Images',
		        extensions: 'gif,jpg,jpeg,bmp,png',
		        mimeTypes: 'image/*'
		    }
		});
		// 当有文件添加进来的时候
	    uploader.on( 'fileQueued', function( file ) {
	        var $li = $(
	                '<div id="' + file.id + '" class="file-item activity_thumbnail">' +
	                    '<img>' +
	                    '<div class="info">' + file.name + '</div>' +
	                '</div>'
	                ),
	        	$btns = $('<div class="file-panel"><span class="cancel">删除</span></div>').appendTo( $li ),
	            $img = $li.find('img');
	        $list.append( $li );
	        $btns.on( 'click', 'span', function() {
                var index = $(this).index();
                switch ( index ) {
                    case 0:
                        var $li = $('#'+file.id);
			            $li.off().find('.file-panel').off().end().remove();
                        return;
                }
            });
	        // 创建缩略图
	        uploader.makeThumb( file, function( error, src ) {
	            if ( error ) {
	                $img.replaceWith('<span>不能预览</span>');
	                return;
	            }
	            $img.attr( 'src', src );
	        }, activity_thumbnailWidth, activity_thumbnailHeight );
	    });
	    // 文件上传过程中创建进度条实时显示。
	    uploader.on( 'uploadProgress', function( file, percentage ) {
	        var $li = $( '#'+file.id ),
	            $percent = $li.find('.progress span');

	        // 避免重复创建
	        if ( !$percent.length ) {
	            $percent = $('<p class="progress"><span></span></p>')
	                    .appendTo( $li )
	                    .find('span');
	        }
	        $percent.css( 'width', percentage * 100 + '%' );

	    });
	    // 文件上传成功，给item添加成功class, 用样式标记上传成功。
	    uploader.on( 'uploadSuccess', function( file,response ) {
	        $('#'+file.id).addClass('upload-state-done');
	        $('#'+file.id).append('<input type="hidden" value="'+response.path+'" name="info[activity_photos][]">');
	    });
	    // 文件上传失败，现实上传出错。
	    uploader.on( 'uploadError', function( file ) {
	        var $li = $( '#'+file.id ),
	            $error = $li.find('div.error');
	        // 避免重复创建
	        if ( !$error.length ) {
	            $error = $('<div class="error"></div>').appendTo( $li );
	        }
	        $error.text('上传失败');
	    });
	    // 完成上传完了，成功或者失败，先删除进度条。
	    uploader.on( 'uploadComplete', function( file ) {
	        $( '#'+file.id ).find('.progress').remove();
	    });
	    //
	    $btn.on( 'click', function() {
	        uploader.upload();
	    });
    })
	function areaEdit(){
	    $(this).siblings("select").show();
	    $(this).siblings("span").andSelf().remove();
	}
    function getAreaChange(){
    	$(this).nextAll("select").remove();
    	var selects = $(this).siblings("select").andSelf();
    	var id = 0;
    	var ids = new Array();
	    var names = new Array();
	    for (i = 0; i < selects.length; i++){
	        sel = selects[i];
	        if (sel.value > 0){
	            id = sel.value;
	            ids.push(id);
	            name = sel.options[sel.selectedIndex].text;
	            names.push(name);
	        }
	    }
	    $('input[name="info[activity_area_ids]"]').val(ids.join(","));
	    $('input[name="info[activity_area_name]"]').val(names.join(","));
	    if (this.value > 0){
	        var _self = this;
	        var url = '__MODULE__/Area/getAreaChildLists';
	        $.post(url, {'pid':this.value}, function(data){
	            if (data){
	                if (data.length > 0){
	                    $("<select class='form-control'><option>-请选择-</option></select>").change(getAreaChange).insertAfter(_self);
	                    var data  = data;
	                    for (i = 0; i < data.length; i++){
	                        $(_self).next("select").append("<option value='" + data[i].id + "'>" + data[i].name + "</option>");
	                    }
	                }
	            }
	        });
	    }
    }

    function geocoder(names) {
		var area = $('input[name="info[activity_area_name]"]').val();
		if(area){
			area = area.replace(",","");
		}
		var activity_address = $('input[name="info[activity_address]"]').val();
	    var geocoder = new AMap.Geocoder({
	        radius: 1000
	    });
	    //地理编码,返回地理编码结果
	    geocoder.getLocation(area+activity_address, function(status, result) {
	        if (status === 'complete' && result.info === 'OK') {
	            geocoder_CallBack(result);
	        }
	    });
	}
	function showAddress(geocode){
	    var html = "<p style=\"font-size: 12px;padding:0px 0 4px 2px; border-bottom:1px solid #C1FFC1;\">" + "<b>地址</b>：" + geocode.formattedAddress + "" + "&nbsp;&nbsp;<b>的地理编码结果是:</b><b>&nbsp;&nbsp;&nbsp;&nbsp;坐标</b>：" + geocode.location.getLng() + ", " + geocode.location.getLat() + "" + "<b>&nbsp;&nbsp;&nbsp;&nbsp;匹配级别</b>：" + geocode.level + "</p>";
	    document.getElementById("result").innerHTML = html;
	}
	function addMarker(i, d) {
		if (marker) {
            marker.setMap(null);
            marker = null;
        }
		$("#lon").val(d.location.getLng());
	    $("#lat").val(d.location.getLat());
	    marker = new AMap.Marker({
	        map: map,
	        position: [ d.location.getLng(),  d.location.getLat()]
	    });
	    var infoWindow = new AMap.InfoWindow({
	        content: d.formattedAddress,
	        offset: {x: 0, y: -30}
	    });
	    marker.on("click", function(e) {
	        infoWindow.open(map, marker.getPosition());
	        $("#lon").val(marker.getPosition().lng);
	        $("#lat").val(marker.getPosition().lat);
	    });
	}
	//地理编码返回结果展示
	function geocoder_CallBack(data) {
	    var resultStr = "";
	    //地理编码结果数组
	    var geocode = data.geocodes;
	    for (var i = 0; i < geocode.length; i++) {
	        //拼接输出html
	        showAddress(geocode[i]);
	        addMarker(i, geocode[i]);
	    }
	    map.setFitView();
	}
	//处理CKEDITOR的值
    function CKupdate(){
        for (instance in CKEDITOR.instances){
            CKEDITOR.instances[instance].updateElement();
        }
    }
	function save() {
		CKupdate();
		DMS.ajaxPost("__CONTROLLER__/activityBuyEdit",$('#form').serialize(),function(ret){
			if(ret.status==1){
            	DMS.success(ret.info,0,function(){
					if(ret.url){
            			window.location.href = ret.url;
            		}else{
            			window.location.href = window.location.href;
            		}
				});
            }else{
            	DMS.error(''+ret.info+'',0);
            }
		})
    }
</script>